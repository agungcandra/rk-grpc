# Meta interceptor
In this example, we will try to create unary grpc server and client with meta interceptor enabled.

Meta interceptor will send bellow headers to client by default.

| Header key | Description |
| ---- | ---- |
| X-Request-Id | Request id generated by the interceptor. |
| X-[Prefix]-App | Application name. |
| X-[Prefix]-App-Version | Version of application. |
| X-[Prefix]-App-Unix-Time | Unix time of current application. |
| X-[Prefix]-Request-Received-Time | Time of current request received by application. |

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Quick start](#quick-start)
  - [Code](#code)
- [Options](#options)
  - [Context Usage](#context-usage)
- [Override RequestId](#override-requestid)
- [Override AppName and AppVersion](#override-appname-and-appversion)
- [Example](#example)
  - [Unary](#unary)
    - [Start server and client](#start-server-and-client)
    - [Output](#output)
    - [Code](#code-1)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Quick start
Get rk-grpc package from the remote repository.

```go
go get -u github.com/rookie-ninja/rk-grpc
```

### Code
Add rkgrpcmeta.UnaryServerInterceptor() meta with option.

```go
import     "github.com/rookie-ninja/rk-grpc/interceptor/meta"
```
```go
    // *************************************
    // ********** Unary Server *************
    // *************************************
    opts := []grpc.ServerOption{
        grpc.ChainUnaryInterceptor(
            // Add meta interceptor
            rkgrpcmeta.UnaryServerInterceptor(),
        ),
    }

    // *************************************
    // ********** Stream Server ************
    // *************************************
    opts := []grpc.ServerOption {
        grpc.ChainStreamInterceptor(
            // Add meta interceptor
            rkgrpcmeta.StreamServerInterceptor(),
        ),
    }
```

## Options
Meta interceptor is only available on server side. The interceptor will send bellow headers back to client.

- X-Request-Id: Generated by [rkcommon.GenerateRequestId()](https://github.com/rookie-ninja/rk-common/blob/master/common/common.go)
- X-RK-App-Name: Retrieved from [rkentry.GlobalAppCtx.GetAppInfoEntry().AppName](https://github.com/rookie-ninja/rk-entry#appinfoentry)
- X-RK-App-Version: Retrieved from [rkentry.GlobalAppCtx.GetAppInfoEntry().Version](https://github.com/rookie-ninja/rk-entry#appinfoentry)
- X-RK-Unix-Time: Server time when request arrives.
- X-RK-Received-Time: Server time when request arrives.

![arch](img/arch.png)

| Name | Description | Default Values |
| ---- | ---- | ---- |
| rkmidmeta.WithEntryNameAndType(entryName, entryType string) | Provide entry name and type if there are multiple meta interceptors needs to be used. | grpc, grpc |
| rkmidmeta.WithPrefix(prefix string) | Provide prefix of meta header | RK |

```go
    // ********************************************
    // ********** Enable interceptors *************
    // ********************************************
    opts := []grpc.ServerOption{
        grpc.ChainUnaryInterceptor(
            rkgrpclog.UnaryServerInterceptor(),
            // Add meta interceptor
            rkgrpcmeta.UnaryServerInterceptor(
                // Entry name and entry type will be used for distinguishing interceptors. Recommended.
                // rkmidmeta.WithEntryNameAndType("greeter", "grpc"),
                //
                // We will replace X-<Prefix>-XXX with prefix user provided.
                // rkmidmeta.WithPrefix("Dog"),
            ),
        ),
    }
```
```shell script
# Print out headers from server on client side.
x-request-id: [c2df6fbd-552d-4425-8d93-0e665e2ba9ee]
x-rk-app-unix-time: [2022-01-15T21:32:46.912377+08:00]
x-rk-received-time: [2022-01-15T21:32:46.912377+08:00]
x-rk-app-name: [rk]
x-rk-app-version: []
content-type: [application/grpc]
x-rk-app-locale: [*::*::*::*]
```

### Context Usage
| Name | Functionality |
| ------ | ------ |
| rkgrpcctx.GetLogger(context.Context) | Get logger generated by log interceptor. If there are X-Request-Id or X-Trace-Id as headers in incoming and outgoing metadata, then loggers will has requestId and traceId attached by default. |
| rkgrpcctx.GetEvent(context.Context) | Get event generated by log intercetor. Event would be printed as soon as RPC finished. ClientStream is a little bit tricky. Please refer rkgrpcctx.FinishClientStream() function for details. |
| rkgrpcctx.GetIncomingHeaders(context.Context) | Get incoming header. ClientStream is a little bit tricky, please use stream.Header() instead. |
| rkgrpcctx.AddHeaderToClient(ctx, "k", "v") | Add k/v to headers which would be sent to client. |
| rkgrpcctx.AddHeaderToServer(ctx, "k", "v") | Add k/v to headers which would be sent to server. |

## Override RequestId
In this example, we will try to override X-Request-Id header with our own. We will send both auto generated requestId and user
requestId to client.

Otherwise, if log interceptor was enabled, we will pick the latest one and attach to event logger and zap logger.

```go
    rkgrpcctx.AddHeaderToClient(ctx, rkmid.HeaderRequestId, "this-is-my-request-id-overridden")
```

```shell script
# Headers sent from server.
x-rk-app-unix-time: [2022-01-15T21:33:56.912831+08:00]
x-request-id: [0a7d5da1-1104-48dc-a018-bba1272b22c4 this-is-my-request-id-overridden]
content-type: [application/grpc]
x-rk-app-name: [rk]
x-rk-app-version: []
x-rk-app-locale: [*::*::*::*]
x-rk-received-time: [2022-01-15T21:33:56.912831+08:00]
x-rk-app-locale: [*::*::*::*]
```

If log interceptor was enabled, we will pick the latest one and attach to event logger and zap logger.
```shell script
# Event logger
------------------------------------------------------------------------
endTime=2022-01-15T21:33:56.913007+08:00
startTime=2022-01-15T21:33:56.912816+08:00
elapsedNano=191231
timezone=CST
ids={"eventId":"this-is-my-request-id-overridden","requestId":"this-is-my-request-id-overridden"}
app={"appName":"rk","appVersion":"","entryName":"c7hcqgbd0cvksb3uq6rg","entryType":""}
env={"arch":"amd64","az":"*","domain":"*","hostname":"lark.local","localIP":"10.8.0.2","os":"darwin","realm":"*","region":"*"}
payloads={"apiMethod":"","apiPath":"/Greeter/SayHello","apiProtocol":"","apiQuery":"","grpcMethod":"SayHello","grpcService":"Greeter","grpcType":"UnaryServer","gwMethod":"","gwPath":"","gwScheme":"","gwUserAgent":"","userAgent":""}
error={}
counters={}
pairs={}
timing={}
remoteAddr=127.0.0.1:62939
operation=/Greeter/SayHello
resCode=OK
eventStatus=Ended
EOE
```

## Override AppName and AppVersion
AppName and AppVersion was retrieved from [rkentry.GlobalAppCtx.GetAppInfoEntry().AppName](https://github.com/rookie-ninja/rk-entry#appinfoentry) and [rkentry.GlobalAppCtx.GetAppInfoEntry().Version](https://github.com/rookie-ninja/rk-entry#appinfoentry).

Override it before grpc server starts.

```go
func main() {
    ...
    // 0: Override AppName and AppVersion
    rkentry.GlobalAppCtx.GetAppInfoEntry().AppName = "demo-app"
    rkentry.GlobalAppCtx.GetAppInfoEntry().Version = "demo-version"

    // 1: Create grpc server
    server := startGreeterServer(opts...)
    ...
}
```

```shell script
# Headers sent from server
x-rk-app-name: [demo-app]
x-rk-app-version: [demo-version]
x-rk-app-unix-time: [2021-06-22T19:10:29.831625+08:00]
x-rk-received-time: [2021-06-22T19:10:29.831625+08:00]
x-request-id: [53365a2c-b0e1-4977-8b84-2b2374434a0f this-is-my-request-id-overridden]
content-type: [application/grpc]
x-rk-app-locale: [*::*::*::*]
```

## Example
### Unary
Create a simple unary server and client with bellow protocol buffer files. We will enable log interceptor at the same time.
- [greeter.proto](../proto/greeter.proto)

#### Start server and client
```shell script
$ go run greeter-server.go
```
```shell script
$ go run greeter-client.go
```

#### Output
- Server side (zap & event)

```shell script
2022-01-15T21:35:31.746+0800    INFO    server/greeter-server.go:69     Received request from client.   {"requestId": "a46e7010-125d-42ea-82e9-fc1e2477794e"}
domain: [test]
:authority: [localhost:8080]
content-type: [application/grpc]
user-agent: [grpc-go/1.42.0]
------------------------------------------------------------------------
endTime=2022-01-15T21:35:31.746571+08:00
startTime=2022-01-15T21:35:31.746488+08:00
elapsedNano=83267
timezone=CST
ids={"eventId":"this-is-my-request-id-overridden","requestId":"this-is-my-request-id-overridden"}
app={"appName":"rk","appVersion":"","entryName":"c7hcqgbd0cvksb3uq6rg","entryType":""}
env={"arch":"amd64","az":"*","domain":"*","hostname":"lark.local","localIP":"10.8.0.2","os":"darwin","realm":"*","region":"*"}
payloads={"apiMethod":"","apiPath":"/Greeter/SayHello","apiProtocol":"","apiQuery":"","grpcMethod":"SayHello","grpcService":"Greeter","grpcType":"UnaryServer","gwMethod":"","gwPath":"","gwScheme":"","gwUserAgent":"","userAgent":""}
error={}
counters={}
pairs={}
timing={}
remoteAddr=127.0.0.1:62945
operation=/Greeter/SayHello
resCode=OK
eventStatus=Ended
EOE

```

- Client side (zap & event)
```shell script
2022-01-15T21:35:31.747+0800    INFO    client/greeter-client.go:38     [Message]: Hello rk-dev!
x-rk-app-locale: [*::*::*::*]
x-request-id: [a46e7010-125d-42ea-82e9-fc1e2477794e this-is-my-request-id-overridden]
x-rk-app-unix-time: [2022-01-15T21:35:31.746493+08:00]
x-rk-app-name: [rk]
x-rk-app-version: []
x-rk-received-time: [2022-01-15T21:35:31.746493+08:00]
content-type: [application/grpc]
```

#### Code
- [greeter-server.go](server/greeter-server.go)
- [greeter-client.go](client/greeter-client.go)
